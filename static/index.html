<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë ˆë²¨ë¯¸ì—… ì›Œí¬ë¶</title>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#4A90D9">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, 'Malgun Gothic', sans-serif; background: #f5f7fa; color: #1a1a1a; min-height: 100vh; }

/* ê³µí†µ */
.container { max-width: 600px; margin: 0 auto; padding: 16px; }
.hidden { display: none !important; }
.btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: #4A90D9; color: white; }
.btn-primary:hover { background: #3a7bc8; }
.btn-primary:disabled { background: #a0c4e8; cursor: not-allowed; }
.btn-orange { background: #E8833A; color: white; }
.btn-orange:hover { background: #d6732a; }
.btn-sm { padding: 8px 16px; font-size: 13px; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
.badge-blue { background: #EBF4FB; color: #4A90D9; }
.badge-green { background: #E8F5E9; color: #2E9E5A; }
.badge-orange { background: #FFF8F0; color: #E8833A; }
.badge-ready { background: #E8F5E9; color: #2E9E5A; }
.badge-pending { background: #FFF8F0; color: #E8833A; }

/* í—¤ë” */
.header { background: linear-gradient(135deg, #4A90D9 0%, #357ABD 100%); color: white; padding: 16px 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 20px; margin-bottom: 2px; }
.header .sub { font-size: 12px; opacity: 0.8; }
.header .logout { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }

/* ë¡œê·¸ì¸ í™”ë©´ */
#login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #4A90D9 0%, #357ABD 100%); }
.login-box { background: white; border-radius: 16px; padding: 40px 32px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
.login-box h1 { font-size: 24px; color: #4A90D9; margin-bottom: 4px; }
.login-box .sub { color: #666; font-size: 13px; margin-bottom: 24px; }
.login-box input { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; text-align: center; margin-bottom: 12px; outline: none; }
.login-box input:focus { border-color: #4A90D9; }
.login-error { color: #dc2626; font-size: 13px; margin-bottom: 8px; }

/* ë©”ì¸ í™”ë©´ */
.section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.section-title { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
.section-title .icon { font-size: 18px; }

/* êµì¬/ë‹¨ì› ì„ íƒ */
select { width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; cursor: pointer; margin-bottom: 8px; }
select:focus { border-color: #4A90D9; outline: none; }

/* ì§€ë¬¸ ëª©ë¡ */
.passage-list { max-height: 240px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
.passage-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s; }
.passage-item:hover { background: #f5f7fa; }
.passage-item:last-child { border-bottom: none; }
.passage-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; accent-color: #4A90D9; }
.passage-item .title { flex: 1; font-size: 14px; }
.passage-item .status { font-size: 11px; }

/* ë‹¨ì› í—¤ë” */
.unit-header { padding: 8px 12px; background: #f0f4f8; font-weight: 700; font-size: 13px; color: #4A90D9; border-bottom: 1px solid #e0e0e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.unit-header:hover { background: #e5edf5; }
.unit-header .unit-select { font-size: 11px; font-weight: 400; color: #666; }

/* ë ˆë²¨ ì„ íƒ */
.level-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.level-btn { padding: 8px 4px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; cursor: pointer; font-size: 12px; transition: all 0.15s; user-select: none; }
.level-btn.selected { border-color: #4A90D9; background: #EBF4FB; color: #4A90D9; font-weight: 600; }
.level-btn.green.selected { border-color: #2E9E5A; background: #E8F5E9; color: #2E9E5A; }
.level-btn.orange.selected { border-color: #E8833A; background: #FFF8F0; color: #E8833A; }
.preset-row { display: flex; gap: 6px; margin-bottom: 8px; }
.preset-btn { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; background: white; font-size: 11px; cursor: pointer; text-align: center; }
.preset-btn:hover { background: #f5f7fa; }

/* ìƒì„± ë²„íŠ¼ */
.generate-area { text-align: center; padding: 8px 0; }
.generate-area .btn { width: 100%; padding: 14px; font-size: 16px; }

/* ì§„í–‰ ìƒíƒœ */
.progress { margin-top: 12px; }
.progress-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #4A90D9, #2E9E5A); border-radius: 3px; transition: width 0.3s; }
.progress-text { font-size: 12px; color: #666; text-align: center; margin-top: 6px; }

/* ê²°ê³¼ */
.result-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 6px; }

/* ì—…ë¡œë“œ */
.upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s; }
.upload-area:hover { border-color: #4A90D9; }
textarea { width: 100%; min-height: 120px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-family: monospace; resize: vertical; }
textarea:focus { border-color: #4A90D9; outline: none; }

/* íƒ­ */
.tabs { display: flex; gap: 4px; margin-bottom: 12px; }
.tab { flex: 1; padding: 10px; text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.tab.active { border-color: #4A90D9; background: #EBF4FB; color: #4A90D9; }

/* í† ìŠ¤íŠ¸ */
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 1000; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } }
</style>
</head>
<body>

<!-- ==================== ë¡œê·¸ì¸ í™”ë©´ ==================== -->
<div id="login-screen">
  <div class="login-box">
    <h1>ğŸ“˜ ë ˆë²¨ë¯¸ì—…</h1>
    <p class="sub">ì›Œí¬ë¶ ìë™ ìƒì„± ì‹œìŠ¤í…œ</p>
    <div id="login-error" class="login-error hidden"></div>
    <input type="password" id="pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
    <button class="btn btn-primary" style="width:100%;" onclick="doLogin()">ë¡œê·¸ì¸</button>
  </div>
</div>

<!-- ==================== ë©”ì¸ í™”ë©´ ==================== -->
<div id="main-screen" class="hidden">
  <div class="header">
    <h1>ğŸ“˜ ë ˆë²¨ë¯¸ì—… ì›Œí¬ë¶</h1>
    <p class="sub">ì›Œí¬ë¶ ìë™ ìƒì„± ì‹œìŠ¤í…œ</p>
    <button class="logout" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div class="container">
    <!-- íƒ­ -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('generate')">ğŸ“„ ì›Œí¬ë¶ ìƒì„±</div>
      <div class="tab" onclick="switchTab('upload')">ğŸ“¤ ì§€ë¬¸ ê´€ë¦¬</div>
    </div>

    <!-- ==================== ìƒì„± íƒ­ ==================== -->
    <div id="tab-generate">
      <!-- êµì¬/ë‹¨ì› ì„ íƒ -->
      <div class="section">
        <div class="section-title"><span class="icon">ğŸ“š</span> êµì¬ ì„ íƒ</div>
        <div style="display:flex;gap:6px;">
          <select id="sel-book" onchange="onBookChange()" style="flex:1;margin-bottom:0;">
            <option value="">êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
          <button class="btn btn-sm" onclick="deleteBook()" style="background:#fee;color:#dc2626;border:1px solid #fca5a5;white-space:nowrap;" title="ì„ íƒí•œ êµì¬ ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
      </div>

      <!-- ì§€ë¬¸ ì„ íƒ -->
      <div class="section">
        <div class="section-title">
          <span class="icon">ğŸ“„</span> ì§€ë¬¸ ì„ íƒ
          <span style="margin-left:auto;font-size:12px;color:#666;" id="sel-count">0ê°œ ì„ íƒ</span>
        </div>
        <div style="margin-bottom:6px;">
          <button class="btn btn-sm" onclick="selectAll()" style="background:#eee;color:#333;margin-right:4px;">ì „ì²´ ì„ íƒ</button>
          <button class="btn btn-sm" onclick="selectNone()" style="background:#eee;color:#333;">ì„ íƒ í•´ì œ</button>
        </div>
        <div class="passage-list" id="passage-list" style="max-height:400px;">
          <div style="padding:20px;text-align:center;color:#999;">êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>
        </div>
      </div>

      <!-- ë ˆë²¨ ì„ íƒ -->
      <div class="section">
        <div class="section-title"><span class="icon">ğŸ¯</span> ë ˆë²¨ ì„ íƒ</div>
        <div class="preset-row">
          <div class="preset-btn" onclick="presetLevels([1,2,3,4])">ìˆ˜ì—… ì „+ì¤‘</div>
          <div class="preset-btn" onclick="presetLevels([5,6,7,8,9,10])">ìˆ˜ì—… í›„</div>
          <div class="preset-btn" onclick="presetLevels([0,1,2,3,4,5,6,7,8,9,10])">ì „ì²´</div>
          <div class="preset-btn" onclick="presetLevels([])">í•´ì œ</div>
        </div>
        <div class="level-grid">
          <div class="level-btn selected" data-level="0" onclick="toggleLevel(this)">í‘œì§€+ì •ë‹µ</div>
          <div class="level-btn selected" data-level="1" onclick="toggleLevel(this)">Lv.1 ì–´íœ˜</div>
          <div class="level-btn selected" data-level="2" onclick="toggleLevel(this)">Lv.2 í•´ì„</div>
          <div class="level-btn green selected" data-level="3" onclick="toggleLevel(this)">Lv.3 ë¶„ì„</div>
          <div class="level-btn green selected" data-level="4" onclick="toggleLevel(this)">Lv.4 êµ¬ì¡°</div>
          <div class="level-btn orange selected" data-level="5" onclick="toggleLevel(this)">Lv.5 ìˆœì„œ</div>
          <div class="level-btn orange selected" data-level="6" onclick="toggleLevel(this)">Lv.6 ë¹ˆì¹¸</div>
          <div class="level-btn orange selected" data-level="7" onclick="toggleLevel(this)">Lv.7 ì£¼ì œ</div>
          <div class="level-btn orange selected" data-level="8" onclick="toggleLevel(this)">Lv.8 ì–´ë²•</div>
          <div class="level-btn orange selected" data-level="9" onclick="toggleLevel(this)">Lv.9 ì–´íœ˜</div>
          <div class="level-btn orange selected" data-level="10" onclick="toggleLevel(this)">Lv.10 ì˜ì‘</div>
        </div>
      </div>

      <!-- ìƒì„± ë²„íŠ¼ -->
      <div class="generate-area">
        <button class="btn btn-primary" id="btn-generate" onclick="doGenerate()" disabled>
          ì›Œí¬ë¶ ìƒì„±í•˜ê¸°
        </button>
        <div class="progress hidden" id="progress">
          <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
          <div class="progress-text" id="progress-text">ì¤€ë¹„ ì¤‘...</div>
        </div>
      </div>

      <!-- ê²°ê³¼ -->
      <div class="section hidden" id="results-section">
        <div class="section-title"><span class="icon">âœ…</span> ìƒì„± ì™„ë£Œ</div>
        <div id="results-list"></div>
      </div>
    </div>

    <!-- ==================== ì—…ë¡œë“œ íƒ­ ==================== -->
    <div id="tab-upload" class="hidden">
      <div class="section">
        <div class="section-title"><span class="icon">ğŸ“¤</span> ì§€ë¬¸ ì—…ë¡œë“œ</div>
        <p style="font-size:13px;color:#666;margin-bottom:8px;">###ê°• ë²ˆí˜¸### í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="upload-book" list="book-list" placeholder="êµì¬ëª… ì…ë ¥ (ì˜ˆ: 26 ìˆ˜íŠ¹ ì˜ì–´)" style="margin-bottom:8px;width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
        <datalist id="book-list"></datalist>
        <textarea id="upload-text" placeholder="###05ê°• 01ë²ˆ###
Many crises today, such as the Great Recession...

###05ê°• 02ë²ˆ###
Consumer surveys indicate that..."></textarea>
        <button class="btn btn-orange" style="width:100%;margin-top:8px;" onclick="doUpload()">ì—…ë¡œë“œ</button>
      </div>

      <div class="section">
        <div class="section-title"><span class="icon">ğŸ“Š</span> í˜„ì¬ ë“±ë¡ëœ ì§€ë¬¸</div>
        <div id="stats-list" style="font-size:13px;color:#666;">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// State
// ============================================================
let TOKEN = localStorage.getItem('wb_token') || '';
let PASSAGES_DATA = null;
let selectedPassages = new Map(); // key -> {book, unit, id}

const API = '';  // ê°™ì€ ì„œë²„

// ============================================================
// Auth
// ============================================================
async function doLogin() {
  const pw = document.getElementById('pw-input').value;
  try {
    const res = await fetch(API + '/api/auth', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({password: pw})
    });
    const data = await res.json();
    if (data.ok) {
      TOKEN = data.token;
      localStorage.setItem('wb_token', TOKEN);
      showMain();
    } else {
      throw new Error();
    }
  } catch(e) {
    document.getElementById('login-error').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤';
    document.getElementById('login-error').classList.remove('hidden');
  }
}

function doLogout() {
  TOKEN = '';
  localStorage.removeItem('wb_token');
  document.getElementById('main-screen').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('pw-input').value = '';
}

function headers() {
  return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + TOKEN };
}

// ============================================================
// Init
// ============================================================
async function showMain() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('main-screen').classList.remove('hidden');
  await loadPassages();
}

async function loadPassages() {
  const prevBook = document.getElementById('sel-book').value;
  const prevSelected = new Map(selectedPassages);
  try {
    const res = await fetch(API + '/api/passages', { headers: headers() });
    if (res.status === 401) { doLogout(); return; }
    PASSAGES_DATA = await res.json();
    updateBookSelect();
    if (prevBook) {
      document.getElementById('sel-book').value = prevBook;
      onBookChange();
      // ì²´í¬ë°•ìŠ¤ ë³µì›
      prevSelected.forEach((val, key) => {
        const cb = document.querySelector(`input[data-key="${key}"]`);
        if (cb) {
          selectedPassages.set(key, val);
          cb.checked = true;
        }
      });
      updateSelCount();
      updateGenerateBtn();
    }
    updateStats();
  } catch(e) {
    console.error(e);
  }
}

// ============================================================
// Selects
// ============================================================
function updateBookSelect() {
  const books = [...new Set(PASSAGES_DATA.map(p => p.book))];
  const sel = document.getElementById('sel-book');
  const prev = sel.value;
  sel.innerHTML = '<option value="">êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
  books.forEach(b => {
    sel.innerHTML += `<option value="${b}">${b}</option>`;
  });
  if (prev && books.includes(prev)) sel.value = prev;
}

function onBookChange() {
  const book = document.getElementById('sel-book').value;
  selectedPassages.clear();
  const list = document.getElementById('passage-list');
  
  if (!book) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">êµì¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>';
    updateSelCount();
    updateGenerateBtn();
    return;
  }
  
  const passages = PASSAGES_DATA.filter(p => p.book === book);
  const units = [...new Set(passages.map(p => p.unit))];
  units.sort((a, b) => (parseInt(a) || 0) - (parseInt(b) || 0));
  
  let html = '';
  for (const unit of units) {
    const unitPassages = passages.filter(p => p.unit === unit);
    html += `<div class="unit-header" onclick="toggleUnit('${book}','${unit}')">
      ğŸ“ ${unit} (${unitPassages.length}ê°œ)
      <span class="unit-select">ë‹¨ì› ì „ì²´ì„ íƒ</span>
    </div>`;
    for (const p of unitPassages) {
      const key = `${p.book}|${p.unit}|${p.id}`;
      html += `<div class="passage-item" style="position:relative;">
        <div style="flex:1;display:flex;align-items:center;" onclick="togglePassage('${p.book}','${p.unit}','${p.id}', this.parentElement)">
          <input type="checkbox" data-key="${key}">
          <span class="title">${p.title}</span>
          <span class="badge ${p.cache_status === 'ready' ? 'badge-ready' : 'badge-pending'}">
            ${p.cache_status === 'ready' ? 'âœ… ì¤€ë¹„ë¨' : 'â³ ë¯¸ìƒì„±'}
          </span>
        </div>
        <button onclick="event.stopPropagation();deletePassage('${p.book}','${p.unit}','${p.id}')" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:14px;padding:4px 6px;opacity:0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5" title="ì§€ë¬¸ ì‚­ì œ">âœ•</button>
      </div>`;
    }
  }
  list.innerHTML = html || '<div style="padding:20px;text-align:center;color:#999;">ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  updateSelCount();
  updateGenerateBtn();
}

function togglePassage(book, unit, id, el) {
  const key = `${book}|${unit}|${id}`;
  const cb = el.querySelector('input[type="checkbox"]');
  if (selectedPassages.has(key)) {
    selectedPassages.delete(key);
    cb.checked = false;
  } else {
    selectedPassages.set(key, {book, unit, id});
    cb.checked = true;
  }
  updateSelCount();
  updateGenerateBtn();
}

function toggleUnit(book, unit) {
  // í•´ë‹¹ ë‹¨ì›ì˜ ëª¨ë“  ì§€ë¬¸ í† ê¸€
  const unitPassages = PASSAGES_DATA.filter(p => p.book === book && p.unit === unit);
  const allSelected = unitPassages.every(p => selectedPassages.has(`${p.book}|${p.unit}|${p.id}`));
  
  unitPassages.forEach(p => {
    const key = `${p.book}|${p.unit}|${p.id}`;
    const cb = document.querySelector(`input[data-key="${key}"]`);
    if (allSelected) {
      selectedPassages.delete(key);
      if (cb) cb.checked = false;
    } else {
      selectedPassages.set(key, {book: p.book, unit: p.unit, id: p.id});
      if (cb) cb.checked = true;
    }
  });
  updateSelCount();
  updateGenerateBtn();
}

function selectAll() {
  const book = document.getElementById('sel-book').value;
  if (!book) return;
  PASSAGES_DATA.filter(p => p.book === book).forEach(p => {
    const key = `${p.book}|${p.unit}|${p.id}`;
    selectedPassages.set(key, {book: p.book, unit: p.unit, id: p.id});
    const cb = document.querySelector(`input[data-key="${key}"]`);
    if (cb) cb.checked = true;
  });
  updateSelCount();
  updateGenerateBtn();
}

function selectNone() {
  selectedPassages.clear();
  document.querySelectorAll('.passage-item input').forEach(cb => cb.checked = false);
  updateSelCount();
  updateGenerateBtn();
}

function updateSelCount() {
  document.getElementById('sel-count').textContent = `${selectedPassages.size}ê°œ ì„ íƒ`;
}

// ============================================================
// Levels
// ============================================================
function toggleLevel(el) {
  el.classList.toggle('selected');
  updateGenerateBtn();
}

function presetLevels(levels) {
  document.querySelectorAll('.level-btn').forEach(el => {
    const lv = parseInt(el.dataset.level);
    if (levels.includes(lv)) {
      el.classList.add('selected');
    } else {
      el.classList.remove('selected');
    }
  });
  updateGenerateBtn();
}

function getSelectedLevels() {
  return [...document.querySelectorAll('.level-btn.selected')].map(el => parseInt(el.dataset.level));
}

// ============================================================
// Generate
// ============================================================
function updateGenerateBtn() {
  const btn = document.getElementById('btn-generate');
  const levels = getSelectedLevels();
  btn.disabled = selectedPassages.size === 0 || levels.length === 0;
  btn.textContent = selectedPassages.size > 0 
    ? `ì›Œí¬ë¶ ìƒì„±í•˜ê¸° (${selectedPassages.size}ê°œ ì§€ë¬¸)` 
    : 'ì›Œí¬ë¶ ìƒì„±í•˜ê¸°';
}

async function doGenerate() {
  const levels = getSelectedLevels();
  const passages = [...selectedPassages.values()]; // [{book, unit, id}, ...]
  
  const btn = document.getElementById('btn-generate');
  const progress = document.getElementById('progress');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  const resultsSection = document.getElementById('results-section');
  const resultsList = document.getElementById('results-list');
  
  btn.disabled = true;
  progress.classList.remove('hidden');
  resultsSection.classList.add('hidden');
  resultsList.innerHTML = '';
  
  let completed = 0;
  const results = [];
  
  for (const p of passages) {
    progressText.textContent = `ìƒì„± ì¤‘... ${completed + 1}/${passages.length} â€” ${p.unit} ${p.id}`;
    progressFill.style.width = `${(completed / passages.length) * 100}%`;
    
    try {
      const res = await fetch(API + '/api/generate', {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify({ book: p.book, unit: p.unit, passage_id: p.id, levels: levels.length === 11 ? null : levels })
      });
      const data = await res.json();
      
      if (data.ok) {
        results.push({ id: `${p.unit} ${p.id}`, status: 'success', html: data.html, filename: data.filename });
      } else {
        results.push({ id: `${p.unit} ${p.id}`, status: 'error', error: data.detail });
      }
    } catch(e) {
      results.push({ id: `${p.unit} ${p.id}`, status: 'error', error: e.message });
    }
    completed++;
    progressFill.style.width = `${(completed / passages.length) * 100}%`;
  }
  
  // ê²°ê³¼ í‘œì‹œ
  progressText.textContent = `ì™„ë£Œ! ${results.filter(r => r.status === 'success').length}/${passages.length} ì„±ê³µ`;
  resultsSection.classList.remove('hidden');
  
  // ì„±ê³µí•œ ê²°ê³¼ë“¤ì˜ HTML ëª¨ì•„ë‘ê¸°
  const successResults = results.filter(r => r.status === 'success');
  
  let mergeBtn = '';
  if (successResults.length > 1) {
    mergeBtn = `<div style="margin-bottom:8px;">
      <button class="btn btn-orange" style="width:100%;" onclick="downloadMerged()">ğŸ“¦ í•©ë³¸ ë‹¤ìš´ë¡œë“œ (${successResults.length}ê°œ)</button>
    </div>`;
  }
  
  // ê°œë³„ ë‹¤ìš´ë¡œë“œ + í•©ë³¸ HTML ì €ì¥
  window._lastResults = successResults;
  
  resultsList.innerHTML = mergeBtn + results.map(r => `
    <div class="result-item">
      <span>${r.status === 'success' ? 'âœ…' : 'âŒ'} ${r.id}</span>
      ${r.status === 'success' 
        ? `<button class="btn btn-sm btn-primary" onclick="downloadHtml(\`${encodeURIComponent(r.html)}\`, '${r.filename}')">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>`
        : `<span style="color:#dc2626;font-size:12px;">${r.error}</span>`
      }
    </div>
  `).join('');
  
  btn.disabled = false;
  // ì„ íƒ ìƒíƒœ ìœ ì§€í•˜ë©´ì„œ ìºì‹œ ìƒíƒœë§Œ ìƒˆë¡œê³ ì¹¨
  await loadPassages();
}

function downloadHtml(encodedHtml, filename) {
  const html = decodeURIComponent(encodedHtml);
  const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function downloadMerged() {
  if (!window._lastResults || window._lastResults.length === 0) return;
  
  // ì²« íŒŒì¼ì—ì„œ CSS ì¶”ì¶œ
  const firstHtml = window._lastResults[0].html;
  const styleMatch = firstHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/);
  const css = styleMatch ? styleMatch[1] : '';
  
  // ê° íŒŒì¼ì—ì„œ body ë‚´ìš©ë§Œ ì¶”ì¶œ
  const bodies = window._lastResults.map(r => {
    const bodyMatch = r.html.match(/<body[^>]*>([\s\S]*?)<\/body>/);
    return bodyMatch ? bodyMatch[1] : r.html;
  });
  
  // í•©ë³¸ ìƒì„±
  const unit = document.getElementById('sel-book').value || 'í•©ë³¸';
  const merged = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>${unit} í•©ë³¸</title>
<style>
${css}
</style>
</head>
<body>
${bodies.join('\n')}
</body>
</html>`;
  
  const blob = new Blob([merged], { type: 'text/html; charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${unit}_í•©ë³¸_ì›Œí¬ë¶.html`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// Delete
// ============================================================
async function deleteBook() {
  const book = document.getElementById('sel-book').value;
  if (!book) { toast('ì‚­ì œí•  êµì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
  if (!confirm(`"${book}" êµì¬ì˜ ëª¨ë“  ì§€ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

  try {
    const res = await fetch(API + '/api/books', {
      method: 'DELETE',
      headers: headers(),
      body: JSON.stringify({ book })
    });
    const data = await res.json();
    if (data.ok) {
      toast(`âœ… "${book}" êµì¬ ì‚­ì œ ì™„ë£Œ`);
      selectedPassages.clear();
      await loadPassages();
      document.getElementById('sel-book').value = '';
      onBookChange();
    }
  } catch(e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
  }
}

async function deletePassage(book, unit, pid) {
  if (!confirm(`"${pid}" ì§€ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  try {
    const res = await fetch(API + '/api/passages', {
      method: 'DELETE',
      headers: headers(),
      body: JSON.stringify({ book, unit, pid })
    });
    const data = await res.json();
    if (data.ok) {
      toast('âœ… ì§€ë¬¸ ì‚­ì œ ì™„ë£Œ');
      const key = `${book}|${unit}|${pid}`;
      selectedPassages.delete(key);
      await loadPassages();
      // í˜„ì¬ êµì¬ ë‹¤ì‹œ ì„ íƒ
      const sel = document.getElementById('sel-book');
      if (sel.value) onBookChange();
    }
  } catch(e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
  }
}

// ============================================================
// Upload
// ============================================================
async function doUpload() {
  const book = document.getElementById('upload-book').value;
  const text = document.getElementById('upload-text').value;
  
  if (!book.trim()) { toast('êµì¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (!text.trim()) { toast('ì§€ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  
  try {
    const res = await fetch(API + '/api/passages/upload', {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ book, text })
    });
    const data = await res.json();
    if (data.ok) {
      toast(`âœ… ${data.count}ê°œ ì§€ë¬¸ ì—…ë¡œë“œ ì™„ë£Œ!`);
      document.getElementById('upload-text').value = '';
      await loadPassages();
    }
  } catch(e) {
    toast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  }
}

function updateStats() {
  if (!PASSAGES_DATA) return;
  const books = {};
  PASSAGES_DATA.forEach(p => {
    if (!books[p.book]) books[p.book] = { total: 0, ready: 0 };
    books[p.book].total++;
    if (p.cache_status === 'ready') books[p.book].ready++;
  });
  
  // êµì¬ ì…ë ¥ ìë™ì™„ì„± ì—…ë°ì´íŠ¸
  const dl = document.getElementById('book-list');
  dl.innerHTML = Object.keys(books).map(b => `<option value="${b}">`).join('');
  
  const el = document.getElementById('stats-list');
  if (Object.keys(books).length === 0) {
    el.innerHTML = '<p>ë“±ë¡ëœ ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”!</p>';
    return;
  }
  el.innerHTML = Object.entries(books).map(([name, info]) => 
    `<p style="margin-bottom:4px;"><strong>${name}</strong>: ${info.total}ê°œ ì§€ë¬¸ (${info.ready}ê°œ ìƒì„±ì™„ë£Œ)</p>`
  ).join('');
}

// ============================================================
// Tabs
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-generate').classList.toggle('hidden', tab !== 'generate');
  document.getElementById('tab-upload').classList.toggle('hidden', tab !== 'upload');
}

// ============================================================
// Utils
// ============================================================
function toast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Enter í‚¤ë¡œ ë¡œê·¸ì¸
document.getElementById('pw-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});

// ìë™ ë¡œê·¸ì¸ ì²´í¬
(async () => {
  if (TOKEN) {
    try {
      const res = await fetch(API + '/api/passages', { headers: headers() });
      if (res.ok) { showMain(); return; }
    } catch(e) {}
  }
  document.getElementById('login-screen').classList.remove('hidden');
})();
</script>
</body>
</html>
